# 验证和调试指南

## ✅ 已添加的验证功能

### 1. WebSocket 连接状态监听

程序现在会显示 WebSocket 的真实连接状态：

```
✅ WebSocket 连接已建立 (WS open)
```

如果连接失败，会显示：
```
❌ WebSocket 连接错误 (WS error): [错误信息]
⚠️  WebSocket 连接关闭 (WS close) - Code: [代码]
```

### 2. Mempool 监听验证

程序会统计并显示 pending 交易数量：

```
📡 Pending 交易计数: 50 (持续监听中...)
📡 Pending 交易计数: 100 (持续监听中...)
```

**验证方法：**
- ✅ 如果 5-20 秒内有 pending 计数输出 → mempool 监听正常
- ❌ 如果一直没有输出 → 可能 RPC 节点不支持 pending 或配置有问题

### 3. 区块监听验证（备选验证）

如果 pending 没有输出，程序会监听新区块：

```
📦 新区块: 12345678 (累计: 1)
📦 新区块: 12345679 (累计: 2)
```

**判断标准：**
- ✅ **block 有输出**：说明 WebSocket 连接和订阅正常，只是 pending 功能受限
- ❌ **block 也没有**：说明 WebSocket 没连上或订阅失败（检查第 1 步的 open/error/close）

### 4. 详细日志输出

程序现在会显示每个关键步骤：

```
🎯 发现目标地址交易!
   Hash: 0x...
   From: 0xe00740bce98a594e26861838885ab310ec3b548c
   To: 0x...
   Value: 0.0 MATIC
   Data: 0x...
   💸 Gas (EIP-1559): maxFee=50.25 gwei, priority=2.4 gwei
   🔄 正在构建跟单交易...

✅ 跟单交易已发送!
   📊 目标交易: 0x...
   📊 跟单交易: 0x...
   💸 Gas: 50.25 gwei
   ⏱️  时间: 14:30:25
```

### 5. 统计信息

每 30 秒自动输出统计：

```
📊 统计信息 (运行中...):
   - Pending 交易数: 1250
   - 新区块数: 5
   - 目标地址交易: 2
   - 成功跟单数: 2
```

## 🔍 如何判断程序是否正常工作

### 正常工作的标志

1. **WebSocket 连接成功**
   ```
   ✅ WebSocket 连接已建立 (WS open)
   ```

2. **Pending 监听正常**（5-20 秒内有输出）
   ```
   📡 Pending 交易计数: 50 (持续监听中...)
   ```

3. **区块监听正常**（如果没有 pending，至少要有区块）
   ```
   📦 新区块: 12345678 (累计: 1)
   ```

4. **发现目标交易时**
   ```
   🎯 发现目标地址交易!
   ✅ 跟单交易已发送!
   ```

### 异常情况的判断

#### 情况 1：Pending 没有输出，但区块有输出

**原因：**
- RPC 节点不支持 pending 功能
- 或 pending 订阅权限受限

**解决方案：**
- 检查 RPC 节点套餐是否支持 pending
- 尝试更换 RPC 节点（QuickNode 通常支持）
- 程序仍可运行，但会延迟（等交易进入区块后才能检测到）

#### 情况 2：Pending 和区块都没有输出

**原因：**
- WebSocket 连接失败
- 订阅失败

**检查步骤：**
1. 查看是否有 "WS open" 消息
2. 查看是否有 "WS error" 或 "WS close" 消息
3. 检查 RPC_WS 配置是否正确
4. 检查网络连接

#### 情况 3：Pending 有输出，但从未发现目标交易

**可能原因：**
1. **目标地址错误** - 检查 TARGET 配置
2. **目标地址最近没有交易** - 等待目标地址发起交易
3. **过滤条件过严** - 检查代码中的过滤逻辑

**验证方法：**
```bash
# 在区块浏览器查看目标地址最近的交易
# 确认地址是否正确
```

#### 情况 4：发现目标交易，但跟单失败

**查看错误信息：**
- `余额不足` → 检查钱包 MATIC 余额
- `Gas 估算失败` → 可能是合约调用问题，检查目标交易是否成功
- `Nonce 冲突` → 正常情况，自动忽略

## 🛠️ 改进的功能

### 1. 重试机制

程序现在会对 `getTransaction` 进行重试（最多 3 次），因为 pending 交易可能一开始查不到：

```typescript
// 重试机制：pending tx 可能一开始查不到
let retries = 3;
while (retries > 0 && !tx) {
  // 尝试获取交易
  // 指数退避重试
}
```

### 2. EIP-1559 和传统 Gas 支持

程序现在正确处理两种 gas 类型：

- **EIP-1559 交易**：使用 `maxFeePerGas` 和 `maxPriorityFeePerGas`
- **传统交易**：使用 `gasPrice`

### 3. 更详细的错误处理

程序现在会区分不同类型的错误：
- Gas 估算失败 → 静默忽略（可能是合约问题）
- Nonce 冲突 → 静默忽略（正常情况）
- 余额不足 → 明确提示
- 其他错误 → 显示详细信息

## 📋 启动后的预期输出

### 正常启动（5-10 秒内）

```
✅ 环境变量验证通过
   RPC_WS: wss://polygon-mainnet.g.alchemy...
   RPC_HTTP: https://polygon-mainnet.g.alchemy...
   TARGET: 0xe00740bce98a594e26861838885ab310ec3b548c

✅ HTTP RPC 连接成功，当前区块: 12345678
✅ WebSocket 连接已建立 (WS open)
🚀 Polygon mempool copy-trading started…
👀 监听地址: 0xe00740bce98a594e26861838885ab310ec3b548c
💰 跟单钱包: 0x3ae723...

📦 新区块: 12345679 (累计: 1)
📡 Pending 交易计数: 50 (持续监听中...)
```

### 发现目标交易时

```
🎯 发现目标地址交易!
   Hash: 0x88d7af87e9b92d574fcb73060303ee68b706650e4d47cc51b8f2aa19c7bb3801
   From: 0xe00740bce98a594e26861838885ab310ec3b548c
   To: 0x...
   Value: 0.0 MATIC
   Data: 0x...
   💸 Gas (EIP-1559): maxFee=50.25 gwei, priority=2.4 gwei
   🔄 正在构建跟单交易...

✅ 跟单交易已发送!
   📊 目标交易: 0x88d7af87e9b92d574fcb73060303ee68b706650e4d47cc51b8f2aa19c7bb3801
   📊 跟单交易: 0x...
   💸 Gas: 50.25 gwei
   ⏱️  时间: 14:30:25
```

## 🎯 关键验证点总结

| 验证项 | 正常标志 | 异常标志 |
|--------|---------|---------|
| WebSocket 连接 | ✅ WS open | ❌ WS error/close |
| Pending 监听 | 📡 5-20秒内有计数 | ⚠️ 一直没有输出 |
| 区块监听 | 📦 有新区块输出 | ❌ 没有区块输出 |
| 目标交易检测 | 🎯 发现目标交易 | ⚠️ 有pending但无目标交易 |
| 跟单执行 | ✅ 跟单交易已发送 | ❌ 跟单失败 |

## 💡 常见问题

### Q: 为什么 pending 计数一直为 0？

A: 可能原因：
1. RPC 节点不支持 pending（检查节点套餐）
2. WebSocket 连接问题（检查 WS open 消息）
3. 网络延迟（等待更长时间）

### Q: 为什么有 pending 但没发现目标交易？

A: 检查：
1. TARGET 地址是否正确
2. 目标地址是否真的在发起交易
3. 在区块浏览器查看目标地址活动

### Q: 跟单交易发送了但没成功？

A: 检查：
1. 钱包余额是否充足
2. Gas 是否设置合理
3. 是否有足够的 approve
4. 查看错误日志
